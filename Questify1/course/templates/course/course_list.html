{% extends "base.html" %}
{% block content %}
<div class="container mt-5">

  <!-- üîç –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <form method="get" action="" class="d-flex flex-grow-1 me-3">
      <input 
        type="text" 
        name="q" 
        class="form-control me-2"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..."
        value="{{ request.GET.q }}">
      <button class="btn btn-primary" type="submit">–ù–∞–π—Ç–∏</button>
    </form>

    <!-- ‚öôÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <select id="sort-select" class="form-select w-auto">
      <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
      <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
      <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
      <option value="level_asc">–£—Ä–æ–≤–µ–Ω—å ‚Üë</option>
      <option value="level_desc">–£—Ä–æ–≤–µ–Ω—å ‚Üì</option>
    </select>
  </div>

  <!-- üéì –°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ -->
  <div id="course-list" class="row">
    {% for course in courses %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 border-0 shadow-sm course-card">
          {% if course.image %}
            <img src="{{ course.image.url }}" class="card-img-top rounded-top" alt="{{ course.title }}" loading="lazy">
          {% else %}
            <img src="https://via.placeholder.com/600x300.png?text=Course+Image" class="card-img-top rounded-top" alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" loading="lazy">
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold">{{ course.title }}</h5>
            <p class="text-muted mb-2">{{ course.description|truncatewords:20 }}</p>

            <div class="mb-2">
              <span class="badge bg-primary-subtle text-primary">–£—Ä–æ–≤–µ–Ω—å: {{ course.get_level_display }}</span>
              {% for cat in course.category.all %}
                <span class="badge bg-success-subtle text-success">{{ cat.name }}</span>
              {% empty %}
                <span class="badge bg-secondary">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
              {% endfor %}
            </div>

            <p class="mb-1"><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{ course.teacher }}</p>
            <p class="mb-2"><strong>–¶–µ–Ω–∞:</strong> <span class="text-success fw-semibold">{{ course.price }} $</span></p>

            <a href="{% url 'course:course_detail' course.id %}" class="btn btn-outline-primary mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12 text-center py-5">
        <h5 class="text-muted">–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üòî</h5>
      </div>
    {% endfor %}
  </div>

  <!-- üîΩ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  {% if page_obj.has_other_pages %}
  <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-5">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.previous_page_number }}">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?q={{ request.GET.q }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- üåà –°—Ç–∏–ª–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
<style>
.course-card {
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.course-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
.bg-primary-subtle { background-color: #e8f0ff; }
.bg-success-subtle { background-color: #e6f9f0; }
</style>

<!-- ‚ö° JS —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const sortSelect = document.getElementById("sort-select");
  const courseList = document.getElementById("course-list");

  sortSelect.addEventListener("change", async function() {
    const sortValue = this.value;
    const searchQuery = new URLSearchParams(window.location.search).get("q") || "";

    const response = await fetch(`?q=${encodeURIComponent(searchQuery)}&sort=${sortValue}`, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });
    const html = await response.text();

    // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ –∫—É—Ä—Å–æ–≤
    const parser = new DOMParser();
    const newDoc = parser.parseFromString(html, "text/html");
    const newCourses = newDoc.querySelector("#course-list");
    courseList.innerHTML = newCourses.innerHTML;
  });
});
</script>
{% endblock %}
