{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <!-- üéì –°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ -->
  <div id="course-list" class="row">
    {% for course in courses %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 border-0 shadow-sm course-card">
          {% if course.image %}
            <img src="{{ course.image.url }}" class="card-img-top rounded-top" alt="{{ course.title }}" loading="lazy">
          {% else %}
            <img src="{% static 'img/default_course.png' %}" class="card-img-top rounded-top" alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" loading="lazy">
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold">{{ course.title }}</h5>
            <p class="text-muted mb-2">{{ course.description|truncatewords:20 }}</p>

            <div class="mb-2">
              <span class="badge bg-primary-subtle text-primary">–£—Ä–æ–≤–µ–Ω—å: {{ course.get_level_display }}</span>
              {% for cat in course.category.all %}
                <span class="badge bg-success-subtle text-success">{{ cat.name }}</span>
              {% empty %}
                <span class="badge bg-secondary">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
              {% endfor %}
            </div>

            <p class="mb-1"><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{ course.teacher }}</p>
            <p class="mb-2"><strong>–¶–µ–Ω–∞:</strong> <span class="text-success fw-semibold">{{ course.price }} $</span></p>

            <a href="{% url 'course:course_detail' course.id %}" class="btn btn-outline-primary mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12 text-center py-5">
        <h5 class="text-muted">–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üòî</h5>
      </div>
    {% endfor %}
  </div>
  <!-- üåê AI-–ß–∞—Ç -->
  <button id="chatToggle" class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle shadow-lg" style="width: 60px; height: 60px;">
  üí¨
  </button>

  <div id="chatBox" class="position-fixed bottom-0 end-0 m-4 bg-light border rounded shadow-lg p-3" style="width: 360px; height: 500px; display: none; flex-direction: column; border-radius: 20px;">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center">
      <img src="{% static 'img/ai_avatar.png' %}" width="32" height="32" class="me-2 rounded-circle" alt="AI">
      <strong>AI-–ø–æ–º–æ—â–Ω–∏–∫</strong>
    </div>
    <button id="chatClose" class="btn btn-sm btn-outline-secondary rounded-circle">‚úñ</button>
  </div>

  <div id="chatMessages" class="flex-grow-1 overflow-auto border p-2 mb-2 rounded" style="background-color: #fff; scroll-behavior: smooth;"></div>

  <form id="chatForm" class="d-flex">
    <input id="chatInput" class="form-control me-2 rounded-pill" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ –∫—É—Ä—Å–∞—Ö..." autocomplete="off">
    <button class="btn btn-primary rounded-pill">‚Üí</button>
  </form>
  </div>

  <!-- üîΩ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  {% if page_obj.has_other_pages %}
  <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-5">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.previous_page_number }}">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?q={{ request.GET.q }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- üåà –°—Ç–∏–ª–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
<style>
.course-card {
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.course-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
.bg-primary-subtle { background-color: #e8f0ff; }
.bg-success-subtle { background-color: #e6f9f0; }
 /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.chat-msg {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.4s ease forwards;
}
@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
    }
}
.chat-bubble {
  padding: 10px 14px;
  border-radius: 20px;
  margin: 6px 0;
  max-width: 80%;
}
.chat-user {
  background-color: #d1e7dd;
  align-self: flex-end;
}
.chat-ai {
  background-color: #f1f1f1;
  align-self: flex-start;
}
</style>


<script>
  // üåê –õ–æ–≥–∏–∫–∞ AI-—á–∞—Ç–∞
  const chatToggle = document.getElementById("chatToggle");
  const chatBox = document.getElementById("chatBox");
  const chatClose = document.getElementById("chatClose");
  const chatForm = document.getElementById("chatForm");
  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");

  chatToggle.onclick = () => chatBox.style.display = "flex";
  chatClose.onclick = () => chatBox.style.display = "none";

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    const userMsg = document.createElement("div");
    userMsg.classList.add("chat-bubble", "chat-user", "chat-msg");
    userMsg.innerHTML = `<strong>–í—ã:</strong> ${message}`;
    chatMessages.appendChild(userMsg);
    chatInput.value = "";

    chatMessages.scrollTop = chatMessages.scrollHeight;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const res = await fetch("{% url 'course:ai_assistant' %}", {
      method: "POST",
      headers: {"X-CSRFToken": "{{ csrf_token }}"},
      body: new URLSearchParams({message})
    });

    const data = await res.json();
    const aiMsg = document.createElement("div");
    aiMsg.classList.add("chat-bubble", "chat-ai", "chat-msg");
    aiMsg.innerHTML = `<img src="{% static 'img/ai_avatar.png' %}" width="24" height="24" class="me-2 rounded-circle"> <strong>AI:</strong> ${data.reply || "–û—à–∏–±–∫–∞: " + data.error}`;
    chatMessages.appendChild(aiMsg);

    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
</script>
{% endblock %}
